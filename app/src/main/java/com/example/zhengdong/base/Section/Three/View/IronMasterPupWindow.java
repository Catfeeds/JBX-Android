/* * Copyright (c) create by ki1lt0 . */package com.example.zhengdong.base.Section.Three.View;import android.annotation.SuppressLint;import android.app.Activity;import android.content.Context;import android.content.Intent;import android.graphics.drawable.ColorDrawable;import android.net.Uri;import android.util.DisplayMetrics;import android.view.KeyEvent;import android.view.LayoutInflater;import android.view.View;import android.view.View.OnClickListener;import android.view.ViewGroup;import android.webkit.DownloadListener;import android.webkit.WebChromeClient;import android.webkit.WebSettings;import android.webkit.WebView;import android.webkit.WebViewClient;import android.widget.LinearLayout;import android.widget.PopupWindow;import android.widget.RelativeLayout;import android.widget.TextView;import com.example.zhengdong.base.APIManager.UrlUtils;import com.example.zhengdong.base.Macro.DesUtils;import com.example.zhengdong.base.Macro.LogUtil;import com.example.zhengdong.base.Macro.SharedPreferencesUtils;import com.example.zhengdong.base.Macro.dzRecycleview.ProgressView;import com.example.zhengdong.base.Section.Login.Controller.LoginAC;import com.example.zhengdong.base.Section.Three.Controller.IronMasterFC;import com.example.zhengdong.jbx.R;import java.text.SimpleDateFormat;import butterknife.BindView;/** * Created by cfwifine on 16/10/28. */public class IronMasterPupWindow extends PopupWindow implements OnClickListener {    private final LinearLayout backLay;    private final TextView naviTitleTxt;    private ProgressView progressView;    @BindView(R.id.navi_back_lay)    LinearLayout naviBackLay;    @BindView(R.id.navi_title_lay)    LinearLayout naviTitleLay;    @BindView(R.id.navi_right_txt)    TextView naviRightTxt;    @BindView(R.id.navi_right_lay)    LinearLayout naviRightLay;    @BindView(R.id.navi_right_pic_lay)    LinearLayout naviRightPicLay;    @BindView(R.id.title_bg)    RelativeLayout titleBg;    @BindView(R.id.master_webview)    WebView masterWebview;    private View mMenueView;    private Context contextx;    String tokenx = "";    @SuppressLint("NewApi")    public IronMasterPupWindow(Activity context,String token ,OnClickListener itemsOnclick) {        super(context);        LayoutInflater inflater = (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);        mMenueView = inflater.inflate(R.layout.iron_master_pop_layout, null);        contextx = context;        tokenx = token;        backLay = (LinearLayout) mMenueView.findViewById(R.id.navi_back_lay);        backLay.setOnClickListener(itemsOnclick);        backLay.setVisibility(View.VISIBLE);        naviTitleTxt = (TextView) mMenueView.findViewById(R.id.navi_title_txt);        naviTitleTxt.setText("钣金大师");        masterWebview = (WebView) mMenueView.findViewById(R.id.master_webview);        initWebView(context);//        progressView = new ProgressView(context);        progressView = (ProgressView) mMenueView.findViewById(R.id.processView);//        progressView.setIndicatorId(0);//        progressView.setIndicatorColor(0x1F7EFF);//        naviBackLay.setOnClickListener(this);        mMenueView.setOnKeyListener(listener);        this.setContentView(mMenueView);        //设置SelectPicPopupWindow弹出窗体的宽        this.setWidth(ViewGroup.LayoutParams.MATCH_PARENT);        //设置SelectPicPopupWindow弹出窗体的高        this.setHeight(ViewGroup.LayoutParams.MATCH_PARENT);        //设置SelectPicPopupWindow弹出窗体可点击        this.setFocusable(true);        //设置SelectPicPopupWindow弹出窗体动画效果        this.setAnimationStyle(R.style.take_photo_anim);        //实例化一个ColorDrawable颜色为半透明        ColorDrawable dw = new ColorDrawable(0xffffff);        //设置SelectPicPopupWindow弹出窗体的背景        this.setBackgroundDrawable(dw);    }    View.OnKeyListener listener = new View.OnKeyListener() {        @Override        public boolean onKey(View view, int keyCode, KeyEvent keyEvent) {            if ((keyEvent.getAction() == KeyEvent.ACTION_DOWN && keyCode == KeyEvent.KEYCODE_BACK)) {                if (masterWebview.canGoBack()) {                    masterWebview.goBack(); //goBack()表示返回WebView的上一页面                    return true;                } else {                    dismiss();                    return true;                }            }            return false;        }    };    // 初始化钣金大师    private void initWebView(final Activity context) {        masterWebview.setOverScrollMode(View.OVER_SCROLL_NEVER);        masterWebview.setScrollBarStyle(View.SCROLLBARS_INSIDE_OVERLAY); // 取消滚动条白边效果        WebSettings setting = masterWebview.getSettings();        setting.setDomStorageEnabled(true);        setting.setAppCacheMaxSize(1024 * 1024 * 8);        String appCachePath = context.getApplicationContext().getCacheDir().getAbsolutePath();        setting.setAppCachePath(appCachePath);        setting.setAllowFileAccess(true);        setting.setAppCacheEnabled(true);        setting.setRenderPriority(WebSettings.RenderPriority.HIGH);        // 允许JS执行        setting.setJavaScriptEnabled(true);        setting.setBlockNetworkImage(false);        DisplayMetrics dm = context.getResources().getDisplayMetrics();        int scale = dm.densityDpi;        if (scale == 240) {            masterWebview.getSettings().setDefaultZoom(WebSettings.ZoomDensity.FAR);        } else if (scale == 160) {            masterWebview.getSettings().setDefaultZoom(WebSettings.ZoomDensity.MEDIUM);        } else {            masterWebview.getSettings().setDefaultZoom(WebSettings.ZoomDensity.CLOSE);        }//        masterWebview.getSettings().setCacheMode(WebSettings.LOAD_NO_CACHE);//        masterWebview.clearCache(true);//        String token = String.valueOf(SharedPreferencesUtils.getParam(context, UrlUtils.APP_TOKEN,""));        SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMddHH");        String key = sdf.format(new java.util.Date());        String url = "";        try {            String desId = DesUtils.encrypt("73", key);            url = UrlUtils.IRON_NEW_MASTER_URL + "?token=" + tokenx;            LogUtil.e("打印的web为"+url);        } catch (Exception e) {        }        masterWebview.loadUrl(url);//        mWebView.loadUrl("http://192.168.10.197:8080/GCGL/html/wap/gc/html/login2.html?u=ctUeDG3x+BU=&client=android");        masterWebview.setWebViewClient(new WebViewClient() {            // 点击超链接的时候重新在原来进程上加载URL            @Override            public boolean shouldOverrideUrlLoading(WebView view, String url) {                view.loadUrl(url);                return true;            }            // webview加载完成            @Override            public void onPageFinished(WebView view, String url) {            }        });        masterWebview.setWebChromeClient(new WebChromeClient() {            public void onProgressChanged(WebView view, int progress) {                // TODO Auto-generated method stub                if (progress == 100) {                    // 网页加载完成                    progressView.setVisibility(View.GONE);                } else {                    // 加载中                    progressView.setVisibility(View.VISIBLE);                }            }        });        masterWebview.setDownloadListener(new MyDownloadListenter());    }    class MyDownloadListenter implements DownloadListener {        @Override        public void onDownloadStart(String url, String userAgent, String contentDisposition, String mimetype, long contentLength) {            //下载任务，主要有两种方式            //（1）自定义下载任务            //（2）调用系统的download的模块            Uri uri = Uri.parse(url);            Intent intent = new Intent(Intent.ACTION_VIEW, uri);            contextx.startActivity(intent);        }    }    @Override    public void onClick(View view) {        switch (view.getId()) {            case R.id.navi_back_lay:                dismiss();                break;        }    }}